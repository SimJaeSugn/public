# 종합 실습 프로젝트: 주문 처리 시스템

## 1. 프로젝트 개요

### 1.1 시스템 요구사항
- **주문 처리**: 사용자가 상품을 주문할 수 있는 시스템
- **재고 관리**: 주문 시 재고를 차감하고 취소 시 복구
- **결제 처리**: 주문에 대한 결제 처리
- **알림 발송**: 주문 완료 시 이메일 알림 발송
- **감사 로그**: 모든 주문 처리 과정을 로그로 기록

### 1.2 기술 스택
- **Spring Boot 2.7.x**
- **Spring Data JPA**
- **H2 Database** (개발용)
- **Spring Boot Test**

### 1.3 도메인 모델
```java
// 주문 엔티티
@Entity
@Table(name = "orders")
public class Order {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private Long userId;
    
    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<OrderItem> items = new ArrayList<>();
    
    @Enumerated(EnumType.STRING)
    private OrderStatus status;
    
    @Column(nullable = false)
    private BigDecimal totalAmount;
    
    @CreationTimestamp
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    private LocalDateTime updatedAt;
    
    // getter, setter 생략
}

// 주문 아이템 엔티티
@Entity
@Table(name = "order_items")
public class OrderItem {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id")
    private Order order;
    
    @Column(nullable = false)
    private Long productId;
    
    @Column(nullable = false)
    private String productName;
    
    @Column(nullable = false)
    private Integer quantity;
    
    @Column(nullable = false)
    private BigDecimal unitPrice;
    
    // getter, setter 생략
}

// 상품 엔티티
@Entity
@Table(name = "products")
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(nullable = false)
    private BigDecimal price;
    
    @Column(nullable = false)
    private Integer stock;
    
    // getter, setter 생략
}

// 주문 상태 열거형
public enum OrderStatus {
    PENDING,    // 대기
    CONFIRMED,  // 확인
    CANCELLED,  // 취소
    COMPLETED   // 완료
}
```

## 2. 서비스 계층 구현

### 2.1 주문 서비스 (OrderService)
```java
@Service
@Transactional(rollbackFor = {BusinessException.class, SystemException.class})
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private ProductService productService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private NotificationService notificationService;
    
    @Autowired
    private AuditService auditService;
    
    /**
     * 주문 생성 및 처리
     */
    public Order createOrder(CreateOrderRequest request) {
        try {
            // 1. 주문 생성
            Order order = createOrderEntity(request);
            
            // 2. 재고 확인 및 차감
            productService.updateInventory(order);
            
            // 3. 주문 저장
            Order savedOrder = orderRepository.save(order);
            
            // 4. 결제 처리
            paymentService.processPayment(savedOrder);
            
            // 5. 주문 상태 업데이트
            savedOrder.setStatus(OrderStatus.CONFIRMED);
            orderRepository.save(savedOrder);
            
            // 6. 알림 발송 (비동기)
            notificationService.sendOrderConfirmationAsync(savedOrder);
            
            // 7. 감사 로그
            auditService.logOrderProcess(savedOrder);
            
            return savedOrder;
            
        } catch (InsufficientStockException e) {
            log.error("Insufficient stock for order: {}", request, e);
            throw new BusinessException("Insufficient stock", e);
            
        } catch (PaymentException e) {
            log.error("Payment failed for order: {}", request, e);
            // 결제 실패 시 재고 복구
            productService.restoreInventory(order);
            throw new BusinessException("Payment failed", e);
            
        } catch (Exception e) {
            log.error("Unexpected error during order creation: {}", request, e);
            throw new SystemException("Order creation failed", e);
        }
    }
    
    /**
     * 주문 취소
     */
    @Transactional(rollbackFor = {BusinessException.class, SystemException.class})
    public void cancelOrder(Long orderId) {
        try {
            Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new BusinessException("Order not found: " + orderId));
            
            if (order.getStatus() != OrderStatus.CONFIRMED) {
                throw new BusinessException("Order cannot be cancelled: " + orderId);
            }
            
            // 1. 재고 복구
            productService.restoreInventory(order);
            
            // 2. 주문 상태 업데이트
            order.setStatus(OrderStatus.CANCELLED);
            orderRepository.save(order);
            
            // 3. 감사 로그
            auditService.logOrderCancellation(order);
            
        } catch (BusinessException e) {
            throw e;
        } catch (Exception e) {
            log.error("Unexpected error during order cancellation: {}", orderId, e);
            throw new SystemException("Order cancellation failed", e);
        }
    }
    
    private Order createOrderEntity(CreateOrderRequest request) {
        Order order = new Order();
        order.setUserId(request.getUserId());
        order.setStatus(OrderStatus.PENDING);
        
        BigDecimal totalAmount = BigDecimal.ZERO;
        for (OrderItemRequest itemRequest : request.getItems()) {
            OrderItem item = new OrderItem();
            item.setProductId(itemRequest.getProductId());
            item.setProductName(itemRequest.getProductName());
            item.setQuantity(itemRequest.getQuantity());
            item.setUnitPrice(itemRequest.getUnitPrice());
            item.setOrder(order);
            
            order.getItems().add(item);
            totalAmount = totalAmount.add(item.getUnitPrice().multiply(BigDecimal.valueOf(item.getQuantity())));
        }
        
        order.setTotalAmount(totalAmount);
        return order;
    }
}
```

### 2.2 상품 서비스 (ProductService)
```java
@Service
@Transactional(rollbackFor = {BusinessException.class, SystemException.class})
public class ProductService {
    
    @Autowired
    private ProductRepository productRepository;
    
    /**
     * 재고 확인 및 차감
     */
    @Transactional(rollbackFor = {InsufficientStockException.class})
    public void updateInventory(Order order) {
        for (OrderItem item : order.getItems()) {
            Product product = productRepository.findById(item.getProductId())
                .orElseThrow(() -> new BusinessException("Product not found: " + item.getProductId()));
            
            if (product.getStock() < item.getQuantity()) {
                throw new InsufficientStockException(
                    "Insufficient stock for product: " + product.getName() + 
                    ", required: " + item.getQuantity() + 
                    ", available: " + product.getStock()
                );
            }
            
            product.setStock(product.getStock() - item.getQuantity());
            productRepository.save(product);
        }
    }
    
    /**
     * 재고 복구
     */
    @Transactional(rollbackFor = {BusinessException.class, SystemException.class})
    public void restoreInventory(Order order) {
        for (OrderItem item : order.getItems()) {
            Product product = productRepository.findById(item.getProductId())
                .orElseThrow(() -> new BusinessException("Product not found: " + item.getProductId()));
            
            product.setStock(product.getStock() + item.getQuantity());
            productRepository.save(product);
        }
    }
}
```

### 2.3 결제 서비스 (PaymentService)
```java
@Service
@Transactional(rollbackFor = {PaymentException.class, SystemException.class})
public class PaymentService {
    
    @Autowired
    private PaymentRepository paymentRepository;
    
    /**
     * 결제 처리
     */
    @Transactional(rollbackFor = {PaymentException.class})
    public void processPayment(Order order) {
        try {
            // 결제 처리 로직
            Payment payment = new Payment();
            payment.setOrderId(order.getId());
            payment.setAmount(order.getTotalAmount());
            payment.setStatus(PaymentStatus.PENDING);
            
            paymentRepository.save(payment);
            
            // 실제 결제 처리 (외부 API 호출 시뮬레이션)
            if (order.getTotalAmount().compareTo(BigDecimal.ZERO) <= 0) {
                throw new PaymentException("Invalid payment amount");
            }
            
            // 결제 성공
            payment.setStatus(PaymentStatus.COMPLETED);
            paymentRepository.save(payment);
            
        } catch (PaymentException e) {
            throw e;
        } catch (Exception e) {
            log.error("Payment processing failed for order: {}", order.getId(), e);
            throw new SystemException("Payment processing failed", e);
        }
    }
}
```

### 2.4 알림 서비스 (NotificationService)
```java
@Service
@Transactional(propagation = Propagation.NOT_SUPPORTED)
public class NotificationService {
    
    @Autowired
    private EmailRepository emailRepository;
    
    /**
     * 주문 확인 이메일 발송 (비동기)
     */
    @Async
    public void sendOrderConfirmationAsync(Order order) {
        try {
            sendOrderConfirmation(order);
        } catch (Exception e) {
            log.error("Failed to send order confirmation email for order: {}", order.getId(), e);
        }
    }
    
    /**
     * 주문 확인 이메일 발송
     */
    public void sendOrderConfirmation(Order order) {
        try {
            Email email = new Email();
            email.setTo("user@example.com");
            email.setSubject("Order Confirmation");
            email.setBody("Your order has been confirmed. Order ID: " + order.getId());
            
            emailRepository.save(email);
            
            // 실제 이메일 발송 로직
            log.info("Order confirmation email sent for order: {}", order.getId());
            
        } catch (Exception e) {
            log.error("Failed to send order confirmation email for order: {}", order.getId(), e);
            throw new NotificationException("Email sending failed", e);
        }
    }
}
```

### 2.5 감사 서비스 (AuditService)
```java
@Service
@Transactional(propagation = Propagation.REQUIRES_NEW)
public class AuditService {
    
    @Autowired
    private AuditLogRepository auditLogRepository;
    
    /**
     * 주문 처리 감사 로그
     */
    public void logOrderProcess(Order order) {
        try {
            AuditLog auditLog = new AuditLog();
            auditLog.setOrderId(order.getId());
            auditLog.setAction("ORDER_PROCESSED");
            auditLog.setDetails("Order processed successfully");
            auditLog.setTimestamp(LocalDateTime.now());
            
            auditLogRepository.save(auditLog);
            
        } catch (Exception e) {
            log.error("Failed to log order process for order: {}", order.getId(), e);
            // 감사 로그 실패는 주문 처리에 영향을 주지 않음
        }
    }
    
    /**
     * 주문 취소 감사 로그
     */
    public void logOrderCancellation(Order order) {
        try {
            AuditLog auditLog = new AuditLog();
            auditLog.setOrderId(order.getId());
            auditLog.setAction("ORDER_CANCELLED");
            auditLog.setDetails("Order cancelled successfully");
            auditLog.setTimestamp(LocalDateTime.now());
            
            auditLogRepository.save(auditLog);
            
        } catch (Exception e) {
            log.error("Failed to log order cancellation for order: {}", order.getId(), e);
        }
    }
}
```

## 3. 컨트롤러 계층 구현

### 3.1 주문 컨트롤러 (OrderController)
```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    /**
     * 주문 생성
     */
    @PostMapping
    public ResponseEntity<OrderResponse> createOrder(@RequestBody @Valid CreateOrderRequest request) {
        try {
            Order order = orderService.createOrder(request);
            OrderResponse response = convertToResponse(order);
            return ResponseEntity.ok(response);
            
        } catch (BusinessException e) {
            log.warn("Business error during order creation: {}", e.getMessage());
            return ResponseEntity.badRequest().body(null);
            
        } catch (SystemException e) {
            log.error("System error during order creation", e);
            return ResponseEntity.status(500).body(null);
            
        } catch (Exception e) {
            log.error("Unexpected error during order creation", e);
            return ResponseEntity.status(500).body(null);
        }
    }
    
    /**
     * 주문 취소
     */
    @PostMapping("/{orderId}/cancel")
    public ResponseEntity<String> cancelOrder(@PathVariable Long orderId) {
        try {
            orderService.cancelOrder(orderId);
            return ResponseEntity.ok("Order cancelled successfully");
            
        } catch (BusinessException e) {
            log.warn("Business error during order cancellation: {}", e.getMessage());
            return ResponseEntity.badRequest().body(e.getMessage());
            
        } catch (SystemException e) {
            log.error("System error during order cancellation", e);
            return ResponseEntity.status(500).body("Internal server error");
            
        } catch (Exception e) {
            log.error("Unexpected error during order cancellation", e);
            return ResponseEntity.status(500).body("Internal server error");
        }
    }
    
    private OrderResponse convertToResponse(Order order) {
        OrderResponse response = new OrderResponse();
        response.setId(order.getId());
        response.setUserId(order.getUserId());
        response.setStatus(order.getStatus());
        response.setTotalAmount(order.getTotalAmount());
        response.setCreatedAt(order.getCreatedAt());
        return response;
    }
}
```

## 4. 테스트 코드 구현

### 4.1 주문 서비스 테스트
```java
@SpringBootTest
@Transactional
class OrderServiceTest {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private ProductRepository productRepository;
    
    @Test
    @DisplayName("주문 생성 성공 테스트")
    void createOrder_Success() {
        // Given
        Product product = createTestProduct();
        productRepository.save(product);
        
        CreateOrderRequest request = createTestOrderRequest(product.getId());
        
        // When
        Order order = orderService.createOrder(request);
        
        // Then
        assertThat(order).isNotNull();
        assertThat(order.getStatus()).isEqualTo(OrderStatus.CONFIRMED);
        assertThat(order.getItems()).hasSize(1);
        
        // 재고 차감 확인
        Product updatedProduct = productRepository.findById(product.getId()).orElseThrow();
        assertThat(updatedProduct.getStock()).isEqualTo(95); // 100 - 5
    }
    
    @Test
    @DisplayName("재고 부족 시 주문 생성 실패 테스트")
    void createOrder_InsufficientStock() {
        // Given
        Product product = createTestProduct();
        product.setStock(0);
        productRepository.save(product);
        
        CreateOrderRequest request = createTestOrderRequest(product.getId());
        
        // When & Then
        assertThatThrownBy(() -> orderService.createOrder(request))
            .isInstanceOf(BusinessException.class)
            .hasMessageContaining("Insufficient stock");
    }
    
    @Test
    @DisplayName("주문 취소 성공 테스트")
    void cancelOrder_Success() {
        // Given
        Order order = createTestOrder();
        order.setStatus(OrderStatus.CONFIRMED);
        orderRepository.save(order);
        
        // When
        orderService.cancelOrder(order.getId());
        
        // Then
        Order cancelledOrder = orderRepository.findById(order.getId()).orElseThrow();
        assertThat(cancelledOrder.getStatus()).isEqualTo(OrderStatus.CANCELLED);
    }
    
    private Product createTestProduct() {
        Product product = new Product();
        product.setName("Test Product");
        product.setPrice(new BigDecimal("100.00"));
        product.setStock(100);
        return product;
    }
    
    private CreateOrderRequest createTestOrderRequest(Long productId) {
        CreateOrderRequest request = new CreateOrderRequest();
        request.setUserId(1L);
        
        OrderItemRequest itemRequest = new OrderItemRequest();
        itemRequest.setProductId(productId);
        itemRequest.setProductName("Test Product");
        itemRequest.setQuantity(5);
        itemRequest.setUnitPrice(new BigDecimal("100.00"));
        
        request.setItems(Arrays.asList(itemRequest));
        return request;
    }
    
    private Order createTestOrder() {
        Order order = new Order();
        order.setUserId(1L);
        order.setStatus(OrderStatus.PENDING);
        order.setTotalAmount(new BigDecimal("500.00"));
        return order;
    }
}
```

### 4.2 통합 테스트
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.ANY)
class OrderIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Autowired
    private ProductRepository productRepository;
    
    @Test
    @DisplayName("주문 생성 통합 테스트")
    void createOrder_IntegrationTest() {
        // Given
        Product product = createTestProduct();
        productRepository.save(product);
        
        CreateOrderRequest request = createTestOrderRequest(product.getId());
        
        // When
        ResponseEntity<OrderResponse> response = restTemplate.postForEntity(
            "/api/orders", request, OrderResponse.class);
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().getStatus()).isEqualTo(OrderStatus.CONFIRMED);
    }
    
    private Product createTestProduct() {
        Product product = new Product();
        product.setName("Test Product");
        product.setPrice(new BigDecimal("100.00"));
        product.setStock(100);
        return product;
    }
    
    private CreateOrderRequest createTestOrderRequest(Long productId) {
        CreateOrderRequest request = new CreateOrderRequest();
        request.setUserId(1L);
        
        OrderItemRequest itemRequest = new OrderItemRequest();
        itemRequest.setProductId(productId);
        itemRequest.setProductName("Test Product");
        itemRequest.setQuantity(5);
        itemRequest.setUnitPrice(new BigDecimal("100.00"));
        
        request.setItems(Arrays.asList(itemRequest));
        return request;
    }
}
```

## 5. 성능 최적화 및 모니터링

### 5.1 트랜잭션 모니터링
```java
@Component
public class TransactionMonitor {
    
    private static final Logger log = LoggerFactory.getLogger(TransactionMonitor.class);
    
    @EventListener
    public void handleTransactionBegin(TransactionBeginEvent event) {
        log.debug("Transaction began: {}", event.getTransactionName());
    }
    
    @EventListener
    public void handleTransactionCommit(TransactionCommitEvent event) {
        log.debug("Transaction committed: {}", event.getTransactionName());
    }
    
    @EventListener
    public void handleTransactionRollback(TransactionRollbackEvent event) {
        log.warn("Transaction rolled back: {}", event.getTransactionName());
    }
}
```

### 5.2 성능 측정
```java
@Component
@Aspect
public class TransactionPerformanceAspect {
    
    private static final Logger log = LoggerFactory.getLogger(TransactionPerformanceAspect.class);
    
    @Around("@annotation(org.springframework.transaction.annotation.Transactional)")
    public Object measureTransactionPerformance(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        try {
            Object result = joinPoint.proceed();
            long executionTime = System.currentTimeMillis() - startTime;
            
            if (executionTime > 1000) { // 1초 이상
                log.warn("Slow transaction detected: {} took {}ms", 
                    joinPoint.getSignature().getName(), executionTime);
            }
            
            return result;
            
        } catch (Exception e) {
            long executionTime = System.currentTimeMillis() - startTime;
            log.error("Transaction failed after {}ms: {}", 
                executionTime, joinPoint.getSignature().getName(), e);
            throw e;
        }
    }
}
```

이제 다음 학습 자료에서 계좌 이체 시스템과 사용자 관리 시스템을 구현해보겠습니다.
