# 5단계 연습문제: 실제 코드 예제와 실습

## 문제 1: 트랜잭션 설계 분석 (20점)

### 문제
다음 코드의 트랜잭션 설계를 분석하고 개선방안을 제시하세요.

```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private LogService logService;
    
    public void processOrder(Order order) {
        try {
            // 1. 주문 저장
            orderRepository.save(order);
            
            // 2. 결제 처리
            paymentService.processPayment(order);
            
            // 3. 이메일 발송
            emailService.sendOrderConfirmation(order);
            
            // 4. 로그 기록
            logService.logOrderProcess(order);
            
        } catch (Exception e) {
            log.error("Order processing failed", e);
            throw e;
        }
    }
}

@Service
@Transactional
public class PaymentService {
    
    public void processPayment(Order order) {
        // 결제 처리 로직
    }
}

@Service
@Transactional
public class EmailService {
    
    public void sendOrderConfirmation(Order order) {
        // 이메일 발송 로직
    }
}

@Service
@Transactional
public class LogService {
    
    public void logOrderProcess(Order order) {
        // 로그 기록 로직
    }
}
```

### 답안 작성
```
트랜잭션 설계 분석:

1. 현재 설계의 문제점:
   - 
   - 
   - 

2. 개선방안:
   - 
   - 
   - 

3. 수정된 코드:
```

---

## 문제 2: 성능 최적화 (25점)

### 문제
다음 코드의 성능 문제를 분석하고 최적화 방안을 제시하세요.

```java
@Service
@Transactional(isolation = Isolation.SERIALIZABLE)
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private EmailService emailService;
    
    public void updateUserProfile(Long userId, UserProfile profile) {
        // 1. 사용자 조회
        User user = userRepository.findById(userId).orElseThrow();
        
        // 2. 프로필 업데이트
        user.setName(profile.getName());
        user.setEmail(profile.getEmail());
        user.setPhone(profile.getPhone());
        
        // 3. 외부 API 호출 (시간이 오래 걸림)
        callExternalAPI(user);
        
        // 4. 사용자 저장
        userRepository.save(user);
        
        // 5. 이메일 발송
        emailService.sendProfileUpdateEmail(user);
    }
    
    private void callExternalAPI(User user) {
        // 외부 API 호출 로직
        // 시간이 오래 걸리는 작업
    }
}
```

### 답안 작성
```
성능 문제 분석:

1. 격리 수준 문제:
   - 
   - 

2. 트랜잭션 범위 문제:
   - 
   - 

3. 외부 API 호출 문제:
   - 
   - 

최적화 방안:

1. 격리 수준 최적화:
   - 
   - 

2. 트랜잭션 범위 최적화:
   - 
   - 

3. 외부 API 호출 최적화:
   - 
   - 

최적화된 코드:
```

---

## 문제 3: 예외 처리 전략 (25점)

### 문제
다음 요구사항에 따라 예외 처리 전략을 설계하고 구현하세요.

**요구사항:**
1. 사용자 등록 시 이메일 중복 확인
2. 사용자 정보 저장
3. 환영 이메일 발송 (실패해도 등록은 완료)
4. 감사 로그 기록 (실패해도 등록은 완료)
5. 적절한 롤백 정책 설정

**제공된 인터페이스:**
```java
public interface UserRepository {
    User save(User user);
    Optional<User> findByEmail(String email);
}

public interface EmailService {
    void sendWelcomeEmail(User user);
}

public interface AuditService {
    void logUserRegistration(User user);
}
```

### 답안 작성
```java
// 1. 사용자 서비스
@Service
@Transactional(rollbackFor = {???})
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private AuditService auditService;
    
    public User registerUser(User user) {
        try {
            // TODO: 사용자 등록 로직 구현
            
        } catch (Exception e) {
            // TODO: 예외 처리
        }
    }
}

// 2. 이메일 서비스
@Service
@Transactional(propagation = Propagation.???)
public class EmailService {
    
    public void sendWelcomeEmail(User user) {
        // TODO: 환영 이메일 발송 로직
    }
}

// 3. 감사 서비스
@Service
@Transactional(propagation = Propagation.???)
public class AuditService {
    
    public void logUserRegistration(User user) {
        // TODO: 사용자 등록 감사 로그 기록
    }
}
```

---

## 문제 4: 동시성 제어 (20점)

### 문제
다음 코드에서 발생할 수 있는 동시성 문제를 분석하고 해결방안을 제시하세요.

```java
@Service
@Transactional
public class InventoryService {
    
    @Autowired
    private ProductRepository productRepository;
    
    public void updateStock(Long productId, int quantity) {
        Product product = productRepository.findById(productId).orElseThrow();
        
        if (product.getStock() < quantity) {
            throw new InsufficientStockException("Insufficient stock");
        }
        
        product.setStock(product.getStock() - quantity);
        productRepository.save(product);
    }
}
```

### 답안 작성
```
동시성 문제 분석:

1. Lost Update 문제:
   - 
   - 

2. Race Condition 문제:
   - 
   - 

3. 데이터 일관성 문제:
   - 
   - 

해결방안:

1. 격리 수준 조정:
   - 
   - 

2. 락 사용:
   - 
   - 

3. 낙관적 락 사용:
   - 
   - 

해결된 코드:
```

---

## 문제 5: 종합 설계 (10점)

### 문제
다음 요구사항에 따라 전체 시스템의 트랜잭션 설계를 제시하세요.

**요구사항:**
- 주문 처리 시스템
- 재고 관리
- 결제 처리
- 알림 발송
- 감사 로그
- 성능 최적화
- 예외 처리

### 답안 작성
```
전체 시스템 트랜잭션 설계:

1. 서비스 계층별 트랜잭션 전략:
   - 주문 서비스: 
   - 재고 서비스: 
   - 결제 서비스: 
   - 알림 서비스: 
   - 감사 서비스: 

2. 트랜잭션 전파 전략:
   - 

3. 격리 수준 전략:
   - 

4. 롤백 정책:
   - 

5. 성능 최적화 전략:
   - 

6. 예외 처리 전략:
   - 

7. 모니터링 전략:
   - 
```

---

## 채점 기준

- **문제 1**: 20점 (트랜잭션 설계 분석)
- **문제 2**: 25점 (성능 최적화)
- **문제 3**: 25점 (예외 처리 전략)
- **문제 4**: 20점 (동시성 제어)
- **문제 5**: 10점 (종합 설계)

**총점: 100점**

## 평가 기준

- **90점 이상**: 우수 - 실무 적용 가능
- **80-89점**: 양호 - 추가 학습 후 실무 적용
- **70-79점**: 보통 - 추가 학습 필요
- **70점 미만**: 미흡 - 5단계 재학습 필요
