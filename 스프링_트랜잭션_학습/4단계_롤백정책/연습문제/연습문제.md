# 4단계 연습문제: 롤백 정책과 예외 처리

## 문제 1: 롤백 정책 기본 이해 (15점)

### 문제
다음 중 트랜잭션 롤백 정책에 대한 설명으로 **틀린** 것은?

1. 언체크 예외(RuntimeException)는 기본적으로 롤백을 발생시킨다
2. 체크 예외(Exception)는 기본적으로 롤백을 발생시키지 않는다
3. rollbackFor 속성으로 특정 예외에 대한 롤백을 설정할 수 있다
4. 예외를 잡아서 처리하면 rollbackFor 설정과 관계없이 롤백된다

### 답안 작성
```
답: 

설명:
```

---

## 문제 2: 예외 처리 패턴 분석 (20점)

### 문제
다음 코드에서 각 예외 처리 패턴의 롤백 동작을 분석하세요.

```java
@Service
@Transactional(rollbackFor = {BusinessException.class, SystemException.class})
public class OrderService {
    
    public void processOrder(Order order) {
        try {
            // 주문 저장
            orderRepository.save(order);
            
            // 결제 처리
            paymentService.processPayment(order);
            
        } catch (PaymentException e) {
            // 패턴 1: 예외를 잡아서 처리
            log.error("Payment failed", e);
            // 롤백 여부: ?
            
        } catch (DataAccessException e) {
            // 패턴 2: 예외를 다시 던지기
            log.error("Database error", e);
            throw e;
            // 롤백 여부: ?
            
        } catch (BusinessException e) {
            // 패턴 3: 예외를 변환하여 던지기
            log.error("Business error", e);
            throw new SystemException("System error", e);
            // 롤백 여부: ?
            
        } catch (Exception e) {
            // 패턴 4: 예외를 잡아서 처리
            log.error("Unexpected error", e);
            // 롤백 여부: ?
        }
    }
}
```

### 답안 작성
```
패턴 1 (PaymentException을 잡아서 처리):
- 롤백 여부: 
- 이유: 

패턴 2 (DataAccessException을 다시 던지기):
- 롤백 여부: 
- 이유: 

패턴 3 (BusinessException을 SystemException으로 변환):
- 롤백 여부: 
- 이유: 

패턴 4 (Exception을 잡아서 처리):
- 롤백 여부: 
- 이유: 
```

---

## 문제 3: 롤백 정책 설정 (25점)

### 문제
다음 요구사항에 따라 적절한 롤백 정책을 설정하세요.

**요구사항:**
1. 비즈니스 예외(BusinessException) 발생 시 롤백
2. 시스템 예외(SystemException) 발생 시 롤백
3. 검증 예외(ValidationException) 발생 시 롤백하지 않음
4. 기타 예외는 기본 정책 적용

**제공된 예외 클래스:**
```java
public class BusinessException extends RuntimeException { }
public class SystemException extends RuntimeException { }
public class ValidationException extends RuntimeException { }
public class DataAccessException extends RuntimeException { }
```

### 답안 작성
```java
@Service
@Transactional(rollbackFor = {???}, noRollbackFor = {???})
public class OrderService {
    
    public void processOrder(Order order) {
        try {
            // 주문 처리 로직
            processOrderLogic(order);
            
        } catch (ValidationException e) {
            // 검증 예외 처리
            handleValidationException(e);
            
        } catch (BusinessException e) {
            // 비즈니스 예외 처리
            handleBusinessException(e);
            throw e;
            
        } catch (SystemException e) {
            // 시스템 예외 처리
            handleSystemException(e);
            throw e;
            
        } catch (DataAccessException e) {
            // 데이터 접근 예외 처리
            handleDataAccessException(e);
            throw e;
        }
    }
}
```

---

## 문제 4: 예외 처리 계층별 전략 (25점)

### 문제
다음 요구사항에 따라 예외 처리 계층별 전략을 구현하세요.

**요구사항:**
1. 서비스 계층: 비즈니스 예외와 시스템 예외 구분
2. 컨트롤러 계층: HTTP 응답 코드별 예외 처리
3. 적절한 롤백 정책 설정
4. 예외 변환 및 로깅 처리

**제공된 인터페이스:**
```java
public interface UserRepository {
    User save(User user);
    User findById(Long id);
}

public class User {
    private Long id;
    private String name;
    private String email;
    // getter, setter 생략
}
```

### 답안 작성
```java
// 1. 서비스 계층
@Service
@Transactional(rollbackFor = {???})
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    public User createUser(User user) {
        try {
            // TODO: 사용자 생성 로직 구현
            
        } catch (Exception e) {
            // TODO: 예외 처리 및 변환
        }
    }
    
    public User findUserById(Long id) {
        try {
            // TODO: 사용자 조회 로직 구현
            
        } catch (Exception e) {
            // TODO: 예외 처리 및 변환
        }
    }
}

// 2. 컨트롤러 계층
@RestController
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @PostMapping("/users")
    public ResponseEntity<User> createUser(@RequestBody User user) {
        try {
            // TODO: 사용자 생성 요청 처리
            
        } catch (Exception e) {
            // TODO: 예외 처리 및 HTTP 응답
        }
    }
    
    @GetMapping("/users/{id}")
    public ResponseEntity<User> getUserById(@PathVariable Long id) {
        try {
            // TODO: 사용자 조회 요청 처리
            
        } catch (Exception e) {
            // TODO: 예외 처리 및 HTTP 응답
        }
    }
}
```

---

## 문제 5: 복잡한 예외 처리 시나리오 (15점)

### 문제
다음 코드의 문제점을 찾고 해결방안을 제시하세요.

```java
@Service
@Transactional(rollbackFor = Exception.class)
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private NotificationService notificationService;
    
    public void processOrder(Order order) {
        try {
            // 1. 주문 저장
            orderRepository.save(order);
            
            // 2. 결제 처리
            paymentService.processPayment(order);
            
            // 3. 알림 발송
            notificationService.sendNotification(order);
            
        } catch (PaymentException e) {
            // 결제 실패 시 로깅만 하고 예외를 던지지 않음
            log.error("Payment failed for order: {}", order.getId(), e);
            // 문제: 롤백되지 않음
            
        } catch (NotificationException e) {
            // 알림 실패 시 로깅만 하고 예외를 던지지 않음
            log.error("Notification failed for order: {}", order.getId(), e);
            // 문제: 롤백되지 않음
            
        } catch (Exception e) {
            // 기타 예외는 다시 던짐
            log.error("Unexpected error for order: {}", order.getId(), e);
            throw e;
        }
    }
}
```

### 답안 작성
```
발견된 문제점:

1. 
   문제: 
   영향: 

2. 
   문제: 
   영향: 

3. 
   문제: 
   영향: 

해결방안:

1. 
   방법: 
   효과: 

2. 
   방법: 
   효과: 

3. 
   방법: 
   효과: 

수정된 코드:
```

---

## 채점 기준

- **문제 1**: 15점 (정답 1개)
- **문제 2**: 20점 (각 패턴당 5점)
- **문제 3**: 25점 (롤백 정책 설정)
- **문제 4**: 25점 (계층별 전략 구현)
- **문제 5**: 15점 (문제 분석 및 해결)

**총점: 100점**

## 평가 기준

- **90점 이상**: 우수 - 다음 단계 학습 가능
- **80-89점**: 양호 - 일부 복습 후 다음 단계 진행
- **70-79점**: 보통 - 추가 학습 필요
- **70점 미만**: 미흡 - 4단계 재학습 필요
