# 2단계 연습문제: 트랜잭션 전파(Propagation) 동작 원리

## 문제 1: 전파 옵션 기본 이해 (15점)

### 문제
다음 코드에서 각 메서드가 어떤 전파 옵션을 사용하고 있는지 분석하고, 호출 순서에 따른 트랜잭션 동작을 설명하세요.

```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private LogService logService;
    
    public void processOrder(Order order) {
        try {
            userService.validateUser(order.getUserId());
            paymentService.processPayment(order);
            logService.logOrder(order);
        } catch (Exception e) {
            logService.logError("Order processing failed", e);
            throw e;
        }
    }
}

@Service
@Transactional(propagation = Propagation.REQUIRED)
public class UserService {
    public void validateUser(Long userId) { }
}

@Service
@Transactional(propagation = Propagation.REQUIRES_NEW)
public class PaymentService {
    public void processPayment(Order order) { }
}

@Service
@Transactional(propagation = Propagation.NOT_SUPPORTED)
public class LogService {
    public void logOrder(Order order) { }
    public void logError(String message, Exception e) { }
}
```

### 답안 작성
```
1. OrderService.processOrder(): 
   전파 옵션: 
   동작: 

2. UserService.validateUser(): 
   전파 옵션: 
   동작: 

3. PaymentService.processPayment(): 
   전파 옵션: 
   동작: 

4. LogService.logOrder(): 
   전파 옵션: 
   동작: 

5. LogService.logError(): 
   전파 옵션: 
   동작: 

전체 호출 순서와 트랜잭션 동작:
```

---

## 문제 2: 전파 옵션별 동작 분석 (20점)

### 문제
다음 시나리오에서 각 전파 옵션의 동작을 설명하세요.

**시나리오 1: 기존 트랜잭션이 있는 상황**
```java
@Service
@Transactional
public class MainService {
    
    @Autowired
    private SubService subService;
    
    public void mainMethod() {
        subService.subMethod();
    }
}

@Service
@Transactional(propagation = Propagation.???) // 각 옵션별로 분석
public class SubService {
    public void subMethod() { }
}
```

**시나리오 2: 기존 트랜잭션이 없는 상황**
```java
@Service
public class MainService {
    
    @Autowired
    private SubService subService;
    
    public void mainMethod() {
        subService.subMethod();
    }
}

@Service
@Transactional(propagation = Propagation.???) // 각 옵션별로 분석
public class SubService {
    public void subMethod() { }
}
```

### 답안 작성
```
시나리오 1 (기존 트랜잭션 있음):

REQUIRED: 
- 

REQUIRES_NEW: 
- 

SUPPORTS: 
- 

NOT_SUPPORTED: 
- 

MANDATORY: 
- 

NEVER: 
- 

NESTED: 
- 

시나리오 2 (기존 트랜잭션 없음):

REQUIRED: 
- 

REQUIRES_NEW: 
- 

SUPPORTS: 
- 

NOT_SUPPORTED: 
- 

MANDATORY: 
- 

NEVER: 
- 

NESTED: 
- 
```

---

## 문제 3: 실제 코드 구현 (25점)

### 문제
다음 요구사항에 따라 적절한 전파 옵션을 사용하여 코드를 구현하세요.

**요구사항:**
1. 주문 처리 시 사용자 검증 (트랜잭션에 참여)
2. 재고 차감 (중첩 트랜잭션, 부분 롤백 가능)
3. 결제 처리 (독립적인 트랜잭션)
4. 이메일 발송 (트랜잭션 없이 실행)
5. 로그 기록 (트랜잭션 없이 실행)
6. 감사 로그 (트랜잭션 필수)

**제공된 인터페이스:**
```java
public interface OrderRepository {
    void save(Order order);
}

public interface UserRepository {
    User findById(Long id);
}

public interface InventoryRepository {
    void updateStock(Long productId, int quantity);
}

public interface PaymentRepository {
    void processPayment(Payment payment);
}

public interface EmailRepository {
    void sendEmail(Email email);
}

public interface LogRepository {
    void saveLog(LogEntry log);
}

public interface AuditRepository {
    void saveAudit(AuditEntry audit);
}
```

### 답안 작성
```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private LogService logService;
    
    @Autowired
    private AuditService auditService;
    
    public void processOrder(Order order) {
        try {
            // TODO: 요구사항에 따라 적절한 전파 옵션을 사용하여 구현
            
        } catch (Exception e) {
            // TODO: 예외 처리
        }
    }
}

// TODO: 각 서비스 클래스들을 적절한 전파 옵션으로 구현
```

---

## 문제 4: 전파 옵션 선택 전략 (20점)

### 문제
다음 상황에서 적절한 전파 옵션을 선택하고 그 이유를 설명하세요.

**상황 1: 사용자 등록 시 이메일 발송**
```java
@Service
@Transactional
public class UserService {
    
    public void registerUser(User user) {
        // 사용자 저장
        userRepository.save(user);
        
        // 이메일 발송 - 어떤 전파 옵션을 사용할까?
        emailService.sendWelcomeEmail(user);
    }
}
```

**상황 2: 주문 처리 시 재고 차감**
```java
@Service
@Transactional
public class OrderService {
    
    public void processOrder(Order order) {
        // 주문 저장
        orderRepository.save(order);
        
        // 재고 차감 - 어떤 전파 옵션을 사용할까?
        inventoryService.updateStock(order);
    }
}
```

**상황 3: 보고서 생성 시 사용자 조회**
```java
@Service
public class ReportService {
    
    public void generateReport() {
        // 사용자 조회 - 어떤 전파 옵션을 사용할까?
        List<User> users = userService.findAllUsers();
        
        // 보고서 생성
        generateReport(users);
    }
}
```

### 답안 작성
```
상황 1: 이메일 발송
선택한 전파 옵션: 
이유: 

상황 2: 재고 차감
선택한 전파 옵션: 
이유: 

상황 3: 사용자 조회
선택한 전파 옵션: 
이유: 
```

---

## 문제 5: 전파 옵션 디버깅 (20점)

### 문제
다음 코드에서 발생할 수 있는 문제점을 찾고 해결방안을 제시하세요.

```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private LogService logService;
    
    public void processOrder(Order order) {
        try {
            userService.validateUser(order.getUserId());
            paymentService.processPayment(order);
            logService.logOrder(order);
        } catch (Exception e) {
            logService.logError("Order processing failed", e);
            throw e;
        }
    }
}

@Service
@Transactional(propagation = Propagation.MANDATORY)
public class UserService {
    public void validateUser(Long userId) { }
}

@Service
@Transactional(propagation = Propagation.REQUIRES_NEW)
public class PaymentService {
    public void processPayment(Order order) { }
}

@Service
@Transactional(propagation = Propagation.NEVER)
public class LogService {
    public void logOrder(Order order) { }
    public void logError(String message, Exception e) { }
}
```

### 답안 작성
```
발견된 문제점:

1. 
   문제: 
   해결방안: 

2. 
   문제: 
   해결방안: 

3. 
   문제: 
   해결방안: 

수정된 코드:
```

---

## 채점 기준

- **문제 1**: 15점 (각 메서드당 3점)
- **문제 2**: 20점 (각 시나리오당 10점)
- **문제 3**: 25점 (완전한 구현)
- **문제 4**: 20점 (각 상황당 6.7점)
- **문제 5**: 20점 (문제점 발견 및 해결)

**총점: 100점**

## 평가 기준

- **90점 이상**: 우수 - 다음 단계 학습 가능
- **80-89점**: 양호 - 일부 복습 후 다음 단계 진행
- **70-79점**: 보통 - 추가 학습 필요
- **70점 미만**: 미흡 - 2단계 재학습 필요
